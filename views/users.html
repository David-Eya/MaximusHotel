<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - Maximus Hotel</title>
    <link rel="icon" href="/MaximusHotel/img/favicon.png" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/MaximusHotel/css/admin.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><img src="/MaximusHotel/img/favicon.png" alt="M" class="logo-letter">aximus Hotel</h4>
        </div>
        <nav class="sidebar-nav">
            <a href="/MaximusHotel/views/index.html" class="nav-item">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="/MaximusHotel/views/users.html" class="nav-item active">
                <i class="fas fa-users"></i> Users
            </a>
            <a href="/MaximusHotel/views/bookings.html" class="nav-item">
                <i class="fas fa-calendar-check"></i> Bookings
            </a>
            <a href="/MaximusHotel/views/rooms.html" class="nav-item">
                <i class="fas fa-bed"></i> Rooms
            </a>
            <a href="/MaximusHotel/views/room-categories.html" class="nav-item">
                <i class="fas fa-tags"></i> Room Categories
            </a>
            <a href="/MaximusHotel/views/profile.html" class="nav-item">
                <i class="fas fa-user"></i> My Profile
            </a>
            <a href="#" id="adminLogout" class="nav-item">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-light d-md-none" id="sidebarToggle" style="background: #084466; border-color: #084466; color: white;">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="mb-0">Users Management</h2>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <span id="adminUserName">Admin</span>
                    <span id="adminUserType" class="user-type">Admin</span>
                </div>
                <a href="/MaximusHotel/views/profile.html" style="text-decoration: none; color: inherit;">
                    <img id="adminProfileImage" src="https://hotelmaximus.bytevortexz.com/profile_img/default.jpg" alt="Admin" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #084466; display: none; cursor: pointer;">
                    <i class="fas fa-user-circle" id="adminProfileIcon" style="font-size: 2rem; cursor: pointer;"></i>
                </a>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Users</h5>
                <div class="d-flex gap-2 align-items-center" style="flex-wrap: nowrap;">
                    <div class="input-group" style="flex: 1 1 auto; min-width: 200px; max-width: 400px;">
                        <input type="text" class="form-control" id="searchUsers" placeholder="Search users...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openUserModal()" style="flex-shrink: 0; white-space: nowrap;">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Contact</th>
                                <th>User Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="usersPagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="fname" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Middle Name</label>
                            <input type="text" class="form-control" id="midname">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lname" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contact</label>
                            <input type="text" class="form-control" id="contact">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Gender</label>
                            <select class="form-control" id="gender">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">User Type *</label>
                            <select class="form-control" id="usertype" required>
                                <option value="Client">Client</option>
                                <option value="Admin">Admin</option>
                                <option value="Incharge">Incharge</option>
                            </select>
                        </div>
                        <div class="mb-3" id="passwordField">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="mb-3" id="resetPasswordField" style="display: none;">
                            <label class="form-label">Reset Password</label>
                            <input type="password" class="form-control" id="resetpassword" placeholder="Leave blank to keep current password">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/MaximusHotel/js/config.js"></script>
    <script src="/MaximusHotel/js/auth.js"></script>
    <script src="/MaximusHotel/js/admin-auth.js"></script>
    <script src="/MaximusHotel/js/admin-api.js"></script>
    <script>
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
        });

        let currentPage = 1;
        const limit = 10;

        function openUserModal(user = null) {
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('passwordField').style.display = 'block';
            document.getElementById('resetPasswordField').style.display = 'none';
            document.getElementById('password').required = true;

            if (user) {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                document.getElementById('userId').value = user.userid;
                document.getElementById('fname').value = user.fname || '';
                document.getElementById('midname').value = user.midname || '';
                document.getElementById('lname').value = user.lname || '';
                document.getElementById('username').value = user.username || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('contact').value = user.contact || '';
                document.getElementById('gender').value = user.gender || '';
                document.getElementById('usertype').value = user.usertype || 'Client';
                document.getElementById('passwordField').style.display = 'none';
                document.getElementById('resetPasswordField').style.display = 'block';
                document.getElementById('password').required = false;
            }
            modal.show();
        }

        // Helper function to properly close modal and remove backdrop
        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;
            
            // Get or create modal instance
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            
            // Hide the modal
            modal.hide();
            
            // Cleanup function - wait for Bootstrap's animation to complete
            const performCleanup = () => {
                // Check if modal is actually hidden (no show class and not in transition)
                const isModalHidden = !modalElement.classList.contains('show') && 
                                     modalElement.style.display === 'none' || 
                                     !modalElement.classList.contains('show');
                
                if (isModalHidden) {
                    // Remove all backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        // Only remove if no modals are showing
                        const showingModals = document.querySelectorAll('.modal.show');
                        if (showingModals.length === 0) {
                            backdrop.remove();
                        }
                    });
                    
                    // Only remove modal-open if no modals are showing
                    const showingModals = document.querySelectorAll('.modal.show');
                    if (showingModals.length === 0) {
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }
                }
            };
            
            // Wait for Bootstrap's fade animation (usually 150ms) plus a buffer
            setTimeout(performCleanup, 350);
            
            // Also listen for the hidden event (fires after animation completes)
            const cleanupHandler = function() {
                performCleanup();
                modalElement.removeEventListener('hidden.bs.modal', cleanupHandler);
            };
            modalElement.addEventListener('hidden.bs.modal', cleanupHandler, { once: true });
        }
        
        // Global cleanup function that runs periodically to catch any missed backdrops
        function cleanupModalBackdrops() {
            // Only cleanup if no modals are showing or in transition
            const showingModals = document.querySelectorAll('.modal.show');
            
            // If no modals are showing, remove orphaned backdrops
            if (showingModals.length === 0) {
                // Wait a bit to ensure transition is complete
                setTimeout(() => {
                    const stillShowing = document.querySelectorAll('.modal.show');
                    if (stillShowing.length === 0) {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        if (backdrops.length > 0) {
                            backdrops.forEach(backdrop => backdrop.remove());
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            document.body.style.paddingRight = '';
                        }
                    }
                }, 100);
            }
        }
        
        // Run cleanup check every 500ms (less aggressive)
        setInterval(cleanupModalBackdrops, 500);

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const newUserType = document.getElementById('usertype').value;
            
            // If editing an existing user and changing from Admin to non-Admin, check admin count
            if (userId) {
                const usersResult = await adminAPI.getUsers('', 1000, 1);
                const users = usersResult.data || usersResult.users || [];
                const currentUser = users.find(u => u.userid == userId);
                
                if (currentUser && currentUser.usertype === 'Admin' && newUserType !== 'Admin') {
                    const adminCount = users.filter(u => u.usertype === 'Admin').length || 0;
                    if (adminCount <= 1) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Cannot Change User Type',
                            text: 'Cannot change user type. At least one admin must remain in the system.',
                            confirmButtonColor: '#084466'
                        });
                        return;
                    }
                }
            }
            
            const userData = {
                fname: document.getElementById('fname').value,
                midname: document.getElementById('midname').value,
                lname: document.getElementById('lname').value,
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                contact: document.getElementById('contact').value,
                gender: document.getElementById('gender').value,
                usertype: newUserType
            };

            if (userId) {
                userData.userid = userId;
                const resetPassword = document.getElementById('resetpassword').value;
                if (resetPassword) {
                    userData.resetpassword = resetPassword;
                }
                const result = await adminAPI.updateUser(userData);
                if (result.success) {
                    closeModal('userModal');
                    // Wait a bit for modal to close before showing toast
                    setTimeout(() => {
                        Toast.fire({ icon: 'success', title: 'User updated successfully' });
                        loadUsers();
                    }, 100);
                } else {
                    Toast.fire({ icon: 'error', title: result.message || 'Failed to update user' });
                }
            } else {
                userData.password = document.getElementById('password').value;
                const result = await adminAPI.createUser(userData);
                if (result.success) {
                    closeModal('userModal');
                    // Wait a bit for modal to close before showing toast
                    setTimeout(() => {
                        Toast.fire({ icon: 'success', title: 'User created successfully' });
                        loadUsers();
                    }, 100);
                } else {
                    Toast.fire({ icon: 'error', title: result.message || 'Failed to create user' });
                }
            }
        }

        async function loadUsers(search = '') {
            try {
                const result = await adminAPI.getUsers(search, limit, currentPage);
                if (result.success) {
                    // Handle response structure - API returns data and pagination
                    const users = result.data || result.users || [];
                    const pagination = result.pagination || {};
                    updateUsersTable(users);
                    updatePagination(
                        pagination.total_items || result.total || 0,
                        pagination.current_page || result.page || currentPage,
                        pagination.items_per_page || result.limit || limit
                    );
                } else {
                    Toast.fire({ icon: 'error', title: result.message || 'Failed to load users' });
                }
            } catch (error) {
                console.error('Error loading users:', error);
                Toast.fire({ icon: 'error', title: 'Failed to load users' });
            }
        }

        function updateUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.userid}</td>
                    <td>${user.fname} ${user.midname || ''} ${user.lname}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.contact || '-'}</td>
                    <td><span class="badge bg-${user.usertype === 'Admin' ? 'success' : user.usertype === 'Incharge' ? 'warning' : 'primary'}">${user.usertype}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openUserModal(${JSON.stringify(user).replace(/"/g, '&quot;')})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.userid})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePagination(total, page, limit) {
            const totalPages = Math.ceil(total / limit);
            const pagination = document.getElementById('usersPagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="if (currentPage > 1) { currentPage--; loadUsers(); } return false;">Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers with ellipsis
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            // First page
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="currentPage = 1; loadUsers(); return false;">1</a>`;
                pagination.appendChild(firstLi);

                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }
            }

            // Page range
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="currentPage = ${i}; loadUsers(); return false;">${i}</a>`;
                pagination.appendChild(li);
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }

                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="currentPage = ${totalPages}; loadUsers(); return false;">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="if (currentPage < ${totalPages}) { currentPage++; loadUsers(); } return false;">Next</a>`;
            pagination.appendChild(nextLi);
        }

        async function deleteUser(userid) {
            // Check if user is Admin before showing confirmation
            const usersResult = await adminAPI.getUsers('', 1000, 1); // Get all users to check
            const users = usersResult.data || usersResult.users || [];
            const userToDelete = users.find(u => u.userid == userid);
            
            let warningText = 'This action cannot be undone!';
            if (userToDelete && userToDelete.usertype === 'Admin') {
                const adminCount = users.filter(u => u.usertype === 'Admin').length || 0;
                if (adminCount <= 1) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Cannot Delete',
                        text: 'Cannot delete the last admin. At least one admin must remain in the system.',
                        confirmButtonColor: '#084466'
                    });
                    return;
                }
                warningText = `Warning: This is an Admin user. ${adminCount - 1} admin(s) will remain after deletion.`;
            }

            const result = await Swal.fire({
                title: 'Delete User?',
                text: warningText,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it'
            });

            if (result.isConfirmed) {
                const apiResult = await adminAPI.deleteUser(userid);
                if (apiResult.success) {
                    Toast.fire({ icon: 'success', title: 'User deleted successfully' });
                    loadUsers();
                } else {
                    Toast.fire({ icon: 'error', title: apiResult.message || 'Failed to delete user' });
                }
            }
        }

        // Live search with debouncing
        let searchTimeout;
        document.getElementById('searchUsers').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = e.target.value;
                currentPage = 1;
                loadUsers(search);
            }, 300); // Wait 300ms after user stops typing
        });

        // Keep search button for manual trigger if needed
        document.getElementById('searchBtn').addEventListener('click', () => {
            const search = document.getElementById('searchUsers').value;
            currentPage = 1;
            loadUsers(search);
        });

        document.getElementById('adminLogout').addEventListener('click', async (e) => {
            e.preventDefault();
            const result = await Swal.fire({
                title: 'Logout?',
                text: 'Are you sure you want to logout?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, logout'
            });

            if (result.isConfirmed) {
                const auth = new Auth();
                await auth.logout();
                Swal.fire({
                    icon: 'success',
                    title: 'Logout Successful',
                    text: 'You have been logged out successfully',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#084466',
                    allowOutsideClick: false,
                    timer: 1500,
                    timerProgressBar: true
                }).then(() => {
                    window.location.href = '/MaximusHotel/login.html';
                });
            }
        });

        // Toggle sidebar on mobile
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const toggle = document.getElementById('sidebarToggle');
            if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && e.target !== toggle && !toggle?.contains(e.target)) {
                    sidebar.classList.remove('open');
                    document.body.classList.remove('sidebar-open');
                }
            }
        });

        // Update admin profile image
        function updateAdminProfileImage(userData) {
            const profileImage = document.getElementById('adminProfileImage');
            const profileIcon = document.getElementById('adminProfileIcon');
            
            // Use CONFIG to get backend URL for profile images
            let imageUrl;
            if (typeof CONFIG !== 'undefined' && CONFIG.getProfileImageUrl) {
                imageUrl = CONFIG.getProfileImageUrl(userData ? userData.image : null);
            } else {
                // Fallback to backend URL
                const backendUrl = 'https://hotelmaximus.bytevortexz.com';
                imageUrl = (userData && userData.image && userData.image.trim() && userData.image !== 'default.jpg')
                    ? `${backendUrl}/profile_img/${userData.image}`
                    : `${backendUrl}/profile_img/default.jpg`;
            }
            profileImage.src = imageUrl;
            profileImage.style.display = 'block';
            if (profileIcon) profileIcon.style.display = 'none';
        }

        // Check if user is incharge and redirect
        function checkInchargeAccess() {
            const userData = new Auth().getUser();
            if (userData && userData.usertype === 'Incharge') {
                Swal.fire({
                    icon: 'error',
                    title: 'Access Denied',
                    text: 'Incharge users do not have access to this page.',
                    confirmButtonColor: '#084466'
                }).then(() => {
                    window.location.href = '/MaximusHotel/views/index.html';
                });
                return false;
            }
            return true;
        }

        // Hide menu items for incharge users
        function updateSidebarNavigation() {
            const userData = new Auth().getUser();
            if (userData && userData.usertype === 'Incharge') {
                const navUsers = document.getElementById('navUsers');
                const navRoomCategories = document.getElementById('navRoomCategories');
                if (navUsers) navUsers.style.display = 'none';
                if (navRoomCategories) navRoomCategories.style.display = 'none';
            } else {
                const navUsers = document.getElementById('navUsers');
                const navRoomCategories = document.getElementById('navRoomCategories');
                if (navUsers) navUsers.style.display = '';
                if (navRoomCategories) navRoomCategories.style.display = '';
            }
        }

        window.onAdminReady = () => {
            if (!checkInchargeAccess()) {
                return;
            }
            const userData = new Auth().getUser();
            if (userData) {
                document.getElementById('adminUserName').textContent = userData.fname || 'Admin';
                document.getElementById('adminUserType').textContent = userData.usertype || 'Admin';
                updateAdminProfileImage(userData);
            }
            updateSidebarNavigation();
            loadUsers();
        };
    </script>
</body>
</html>










