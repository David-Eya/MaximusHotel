<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Categories Management - Maximus Hotel</title>
    <link rel="icon" href="/MaximusHotel/img/favicon.png" />
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/MaximusHotel/css/admin.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><img src="/MaximusHotel/img/favicon.png" alt="M" class="logo-letter">aximus Hotel</h4>
        </div>
        <nav class="sidebar-nav">
            <a href="/MaximusHotel/views/index.html" class="nav-item">
                <i class="fas fa-chart-line"></i> Dashboard
            </a>
            <a href="/MaximusHotel/views/users.html" class="nav-item">
                <i class="fas fa-users"></i> Users
            </a>
            <a href="/MaximusHotel/views/bookings.html" class="nav-item">
                <i class="fas fa-calendar-check"></i> Bookings
            </a>
            <a href="/MaximusHotel/views/rooms.html" class="nav-item">
                <i class="fas fa-bed"></i> Rooms
            </a>
            <a href="/MaximusHotel/views/room-categories.html" class="nav-item active">
                <i class="fas fa-tags"></i> Room Categories
            </a>
            <a href="/MaximusHotel/views/profile.html" class="nav-item">
                <i class="fas fa-user"></i> My Profile
            </a>
            <a href="#" id="adminLogout" class="nav-item">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-outline-light d-md-none" id="sidebarToggle" style="background: #084466; border-color: #084466; color: white;">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 class="mb-0">Room Categories Management</h2>
            </div>
            <div class="user-info">
                <div class="user-details">
                    <span id="adminUserName">Admin</span>
                    <span id="adminUserType" class="user-type">Admin</span>
                </div>
                <a href="/MaximusHotel/views/profile.html" style="text-decoration: none; color: inherit;">
                    <img id="adminProfileImage" src="/MaximusHotel/profile_img/default.jpg" alt="Admin" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #084466; display: none; cursor: pointer;">
                    <i class="fas fa-user-circle" id="adminProfileIcon" style="font-size: 2rem; cursor: pointer;"></i>
                </a>
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Room Categories</h5>
                <div class="d-flex gap-2 align-items-center" style="flex-wrap: nowrap;">
                    <div class="input-group" style="flex: 1 1 auto; min-width: 200px; max-width: 400px;">
                        <input type="text" class="form-control" id="searchCategories" placeholder="Search categories...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal" onclick="openCategoryModal()" style="flex-shrink: 0; white-space: nowrap;">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Image</th>
                                <th>Category Name</th>
                                <th>Price</th>
                                <th>Capacity</th>
                                <th>Bed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <tr><td colspan="7" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination justify-content-center" id="categoriesPagination"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal fade" id="categoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalTitle">Add Room Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="categoryForm" enctype="multipart/form-data">
                        <input type="hidden" id="categoryId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Category Name *</label>
                                    <input type="text" class="form-control" id="categoryName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Price *</label>
                                    <input type="number" step="0.01" class="form-control" id="price" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Capacity *</label>
                                    <input type="text" class="form-control" id="capacity" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Bed Type *</label>
                                    <input type="text" class="form-control" id="bed" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Description *</label>
                                    <textarea class="form-control" id="description" rows="4" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Services</label>
                                    <textarea class="form-control" id="services" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Image</label>
                                    <input type="file" class="form-control" id="image" accept="image/*">
                                    <small class="text-muted">Leave blank to keep current image</small>
                                    <div id="currentImage" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">Save Category</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/MaximusHotel/js/auth.js"></script>
    <script src="/MaximusHotel/js/admin-auth.js"></script>
    <script src="/MaximusHotel/js/admin-api.js"></script>
    <script>
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
        });

        let currentPage = 1;
        const limit = 10;

        function openCategoryModal(category = null) {
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('currentImage').innerHTML = '';
            document.getElementById('categoryModalTitle').textContent = 'Add Room Category';

            if (category) {
                document.getElementById('categoryModalTitle').textContent = 'Edit Room Category';
                document.getElementById('categoryId').value = category.category_id;
                document.getElementById('categoryName').value = category.category_name || '';
                document.getElementById('price').value = category.price || '';
                document.getElementById('capacity').value = category.capacity || '';
                document.getElementById('bed').value = category.bed || '';
                document.getElementById('description').value = category.description || '';
                document.getElementById('services').value = category.services || '';
                
                if (category.image) {
                    document.getElementById('currentImage').innerHTML = `
                        <img src="/MaximusHotel/img/room/${category.image}" alt="Current image" style="max-width: 200px; border-radius: 5px;">
                    `;
                }
            }
            modal.show();
        }

        // Helper function to properly close modal and remove backdrop
        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (!modalElement) return;
            
            // Get or create modal instance
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            
            // Hide the modal
            modal.hide();
            
            // Cleanup function - wait for Bootstrap's animation to complete
            const performCleanup = () => {
                // Check if modal is actually hidden (no show class and not in transition)
                const isModalHidden = !modalElement.classList.contains('show') && 
                                     modalElement.style.display === 'none' || 
                                     !modalElement.classList.contains('show');
                
                if (isModalHidden) {
                    // Remove all backdrops
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        // Only remove if no modals are showing
                        const showingModals = document.querySelectorAll('.modal.show');
                        if (showingModals.length === 0) {
                            backdrop.remove();
                        }
                    });
                    
                    // Only remove modal-open if no modals are showing
                    const showingModals = document.querySelectorAll('.modal.show');
                    if (showingModals.length === 0) {
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }
                }
            };
            
            // Wait for Bootstrap's fade animation (usually 150ms) plus a buffer
            setTimeout(performCleanup, 350);
            
            // Also listen for the hidden event (fires after animation completes)
            const cleanupHandler = function() {
                performCleanup();
                modalElement.removeEventListener('hidden.bs.modal', cleanupHandler);
            };
            modalElement.addEventListener('hidden.bs.modal', cleanupHandler, { once: true });
        }
        
        // Global cleanup function that runs periodically to catch any missed backdrops
        function cleanupModalBackdrops() {
            // Only cleanup if no modals are showing or in transition
            const showingModals = document.querySelectorAll('.modal.show');
            const transitioningModals = document.querySelectorAll('.modal.fade:not(.show)');
            
            // If no modals are showing and not transitioning, remove orphaned backdrops
            if (showingModals.length === 0) {
                // Wait a bit to ensure transition is complete
                setTimeout(() => {
                    const stillShowing = document.querySelectorAll('.modal.show');
                    if (stillShowing.length === 0) {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        if (backdrops.length > 0) {
                            backdrops.forEach(backdrop => backdrop.remove());
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                            document.body.style.paddingRight = '';
                        }
                    }
                }, 100);
            }
        }
        
        // Run cleanup check every 500ms (less aggressive)
        setInterval(cleanupModalBackdrops, 500);

        async function saveCategory() {
            const categoryId = document.getElementById('categoryId').value;
            const formData = new FormData();
            
            formData.append('category_name', document.getElementById('categoryName').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('capacity', document.getElementById('capacity').value);
            formData.append('bed', document.getElementById('bed').value);
            formData.append('services', document.getElementById('services').value);

            const imageFile = document.getElementById('image').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            if (categoryId) {
                formData.append('category_id', categoryId);
                const result = await adminAPI.updateRoomCategory(formData);
                if (result.success) {
                    closeModal('categoryModal');
                    // Wait a bit for modal to close before showing toast
                    setTimeout(() => {
                        Toast.fire({ icon: 'success', title: 'Category updated successfully' });
                        loadCategories();
                    }, 100);
                } else {
                    Toast.fire({ icon: 'error', title: result.message || 'Failed to update category' });
                }
            } else {
                const result = await adminAPI.createRoomCategory(formData);
                if (result.success) {
                    closeModal('categoryModal');
                    // Wait a bit for modal to close before showing toast
                    setTimeout(() => {
                        Toast.fire({ icon: 'success', title: 'Category created successfully' });
                        loadCategories();
                    }, 100);
                } else {
                    Toast.fire({ icon: 'error', title: result.message || 'Failed to create category' });
                }
            }
        }

        async function loadCategories(search = '') {
            try {
                const result = await adminAPI.getRoomCategoriesList(search, limit, currentPage);
                if (result.success) {
                    // Handle response structure - API returns data and pagination
                    const categories = result.data || result.categories || [];
                    const pagination = result.pagination || {};
                    updateCategoriesTable(categories);
                    updatePagination(
                        pagination.total_items || result.total || 0,
                        pagination.current_page || result.page || currentPage,
                        pagination.items_per_page || result.limit || limit
                    );
                } else {
                    Toast.fire({ icon: 'error', title: result.message || 'Failed to load categories' });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                Toast.fire({ icon: 'error', title: 'Failed to load categories' });
            }
        }

        function updateCategoriesTable(categories) {
            const tbody = document.getElementById('categoriesTableBody');
            if (categories.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No categories found</td></tr>';
                return;
            }

            tbody.innerHTML = categories.map(category => `
                <tr>
                    <td>${category.category_id}</td>
                    <td>
                        ${category.image ? `
                            <img src="/MaximusHotel/img/room/${category.image}" alt="${category.category_name}" 
                                 style="width: 80px; height: 60px; object-fit: cover; border-radius: 5px;">
                        ` : '<span class="text-muted">No image</span>'}
                    </td>
                    <td>${category.category_name}</td>
                    <td>â‚±${parseFloat(category.price || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
                    <td>${category.capacity || '-'}</td>
                    <td>${category.bed || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="openCategoryModal(${JSON.stringify(category).replace(/"/g, '&quot;')})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCategory(${category.category_id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updatePagination(total, page, limit) {
            const totalPages = Math.ceil(total / limit);
            const pagination = document.getElementById('categoriesPagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) {
                return;
            }

            const search = document.getElementById('searchCategories').value;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="if (currentPage > 1) { currentPage--; loadCategories('${search}'); } return false;">Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers with ellipsis
            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            // First page
            if (startPage > 1) {
                const firstLi = document.createElement('li');
                firstLi.className = 'page-item';
                firstLi.innerHTML = `<a class="page-link" href="#" onclick="currentPage = 1; loadCategories('${search}'); return false;">1</a>`;
                pagination.appendChild(firstLi);

                if (startPage > 2) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }
            }

            // Page range
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="currentPage = ${i}; loadCategories('${search}'); return false;">${i}</a>`;
                pagination.appendChild(li);
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsisLi = document.createElement('li');
                    ellipsisLi.className = 'page-item disabled';
                    ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
                    pagination.appendChild(ellipsisLi);
                }

                const lastLi = document.createElement('li');
                lastLi.className = 'page-item';
                lastLi.innerHTML = `<a class="page-link" href="#" onclick="currentPage = ${totalPages}; loadCategories('${search}'); return false;">${totalPages}</a>`;
                pagination.appendChild(lastLi);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${page === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="if (currentPage < ${totalPages}) { currentPage++; loadCategories('${search}'); } return false;">Next</a>`;
            pagination.appendChild(nextLi);
        }

        async function deleteCategory(category_id) {
            const result = await Swal.fire({
                title: 'Delete Category?',
                text: 'This action cannot be undone! Make sure no rooms are using this category.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it'
            });

            if (result.isConfirmed) {
                const apiResult = await adminAPI.deleteRoomCategory(category_id);
                if (apiResult.success) {
                    Toast.fire({ icon: 'success', title: 'Category deleted successfully' });
                    loadCategories();
                } else {
                    Toast.fire({ icon: 'error', title: apiResult.message || 'Failed to delete category' });
                }
            }
        }

        // Live search with debouncing
        let searchTimeout;
        document.getElementById('searchCategories').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = e.target.value;
                currentPage = 1;
                loadCategories(search);
            }, 300); // Wait 300ms after user stops typing
        });

        // Keep search button for manual trigger if needed
        document.getElementById('searchBtn').addEventListener('click', () => {
            const search = document.getElementById('searchCategories').value;
            currentPage = 1;
            loadCategories(search);
        });

        document.getElementById('adminLogout').addEventListener('click', async (e) => {
            e.preventDefault();
            const result = await Swal.fire({
                title: 'Logout?',
                text: 'Are you sure you want to logout?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, logout'
            });

            if (result.isConfirmed) {
                const auth = new Auth();
                await auth.logout();
                Swal.fire({
                    icon: 'success',
                    title: 'Logout Successful',
                    text: 'You have been logged out successfully',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#084466',
                    allowOutsideClick: false,
                    timer: 1500,
                    timerProgressBar: true
                }).then(() => {
                    window.location.href = '/login.html';
                });
            }
        });

        // Toggle sidebar on mobile
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('open');
            document.body.classList.toggle('sidebar-open');
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const toggle = document.getElementById('sidebarToggle');
            if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && e.target !== toggle && !toggle?.contains(e.target)) {
                    sidebar.classList.remove('open');
                    document.body.classList.remove('sidebar-open');
                }
            }
        });

        // Update admin profile image
        function updateAdminProfileImage(userData) {
            const profileImage = document.getElementById('adminProfileImage');
            const profileIcon = document.getElementById('adminProfileIcon');
            
            if (userData && userData.image) {
                profileImage.src = `/profile_img/${userData.image}`;
                profileImage.style.display = 'block';
                if (profileIcon) profileIcon.style.display = 'none';
            } else {
                profileImage.src = '/MaximusHotel/profile_img/default.jpg';
                profileImage.style.display = 'block';
                if (profileIcon) profileIcon.style.display = 'none';
            }
        }

        // Check if user is incharge and redirect
        function checkInchargeAccess() {
            const userData = new Auth().getUser();
            if (userData && userData.usertype === 'Incharge') {
                Swal.fire({
                    icon: 'error',
                    title: 'Access Denied',
                    text: 'Incharge users do not have access to this page.',
                    confirmButtonColor: '#084466'
                }).then(() => {
                    window.location.href = '/admin/index.html';
                });
                return false;
            }
            return true;
        }

        // Hide menu items for incharge users
        function updateSidebarNavigation() {
            const userData = new Auth().getUser();
            if (userData && userData.usertype === 'Incharge') {
                const navUsers = document.getElementById('navUsers');
                const navRoomCategories = document.getElementById('navRoomCategories');
                if (navUsers) navUsers.style.display = 'none';
                if (navRoomCategories) navRoomCategories.style.display = 'none';
            } else {
                const navUsers = document.getElementById('navUsers');
                const navRoomCategories = document.getElementById('navRoomCategories');
                if (navUsers) navUsers.style.display = '';
                if (navRoomCategories) navRoomCategories.style.display = '';
            }
        }

        window.onAdminReady = () => {
            if (!checkInchargeAccess()) {
                return;
            }
            const userData = new Auth().getUser();
            if (userData) {
                document.getElementById('adminUserName').textContent = userData.fname || 'Admin';
                document.getElementById('adminUserType').textContent = userData.usertype || 'Admin';
                updateAdminProfileImage(userData);
            }
            updateSidebarNavigation();
            loadCategories();
        };
    </script>
</body>
</html>





